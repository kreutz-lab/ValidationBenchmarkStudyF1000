#' @name bs_doSimParaChange
#' @description Change simulation parameters for each condition. 
#' @param params List of simulation parameters generated by metaSPARSim
#' @param  simParaChange "normal_to_phi" Multiplies for each condition params$variability with factor 2^(rnorm(, mu, sd)). mu1 & sd1 and mu2$sd2 need to be specified
#' @param  simParaChange "normal_to_mu
#' @param simParaChangeList list(mu1, sd1, mu2, sd2) Parameters for normal distribution to draw noise from. 1&2 refers to the two conditions

 
bs_doSimParaChange <- function(params,simParaChange,simParaChangeList){
  
  done = FALSE
  
  # Option1: Add normal noise to variability.
  if(simParaChange=="normal_to_phi"){
    if(is.null(simParaChangeList$mu1) || is.null(simParaChangeList$sd1) || is.null(simParaChangeList$mu2) || is.null(simParaChangeList$sd2)){
      stop("mu1 and sd1 to draw normal noise for condition1 need to be specified. No noise added to condition1")
    }
    else{
      # Add normal noise to condition1
      print("Normal noise to var with mu1 and sd1 added to condition1")
      factor1 <- 2^rnorm(length(params[[1]]$variability), mean=simParaChangeList$mu1, sd=simParaChangeList$sd1)
      params[[1]]$variability <- params[[1]]$variability*factor1
      params[[1]]$simParaChangeList <- simParaChangeList
      params[[1]]$simParaChange <- simParaChange
      params[[1]]$label <-  paste0("mu1(", simParaChangeList$mu1,")_sd1(",simParaChangeList$sd1,")")

      # Add normal noise to condition2
      print("Normal noise to var with mu2 and sd2 added to condition2")
      factor2 <- 2^rnorm(length(params[[2]]$variability), mean=simParaChangeList$mu2, sd=simParaChangeList$sd2)
      params[[2]]$variability <- params[[2]]$variability*factor2
      params[[2]]$simParaChangeList <- simParaChangeList
      params[[2]]$simParaChange <- simParaChange
      params[[2]]$label <-  paste0("mu2(", simParaChangeList$mu2,")_sd2(",simParaChangeList$sd2,")")
    }
    done = TRUE
  }
  
  # Option2: Add normal noise to intensity (mean)
  if(simParaChange=="normal_to_mu"){
      if(is.null(simParaChangeList$mu1) || is.null(simParaChangeList$sd1) || is.null(simParaChangeList$mu2) || is.null(simParaChangeList$sd2)){
        stop("mu1 and sd1 to draw normal noise for condition1 need to be specified. No noise added to condition1")
  }
      else{
        # Add normal noise to condition1
        print("Normal noise to mean with mu1 and sd1 added to condition1")
        factor1 <- 2^rnorm(length(params[[1]]$intensity), mean=simParaChangeList$mu1, sd=simParaChangeList$sd1)
        params[[1]]$intensity <- params[[1]]$intensity*factor1
        params[[1]]$simParaChangeList <- simParaChangeList
        params[[1]]$simParaChange <- simParaChange
        
        # Add normal noise to condition2
        print("Normal noise to mean with mu2 and sd2 added to condition2")
        factor2 <- 2^rnorm(length(params[[2]]$intensity), mean=simParaChangeList$mu2, sd=simParaChangeList$sd2)
        params[[2]]$intensity <- params[[2]]$intensity*factor2
        params[[2]]$simParaChangeList <- simParaChangeList
        params[[2]]$simParaChange <- simParaChange
      }
    done=TRUE
      }
  
      # Option3: Add normal noise to library size
      if(simParaChange=="normal_to_libsize"){
          if(is.null(simParaChangeList$mu1) || is.null(simParaChangeList$sd1) || is.null(simParaChangeList$mu2) || is.null(simParaChangeList$sd2)){
            stop("mu1 and sd1 to draw normal noise for condition1 need to be specified. No noise added to condition1")
      }
          else{
            # Add normal noise to condition1
            print("Normal noise to lib size with mu1 and sd1 added to condition1")
            factor1 <- 2^rnorm(length(params[[1]]$lib_size), mean=simParaChangeList$mu1, sd=simParaChangeList$sd1)
            params[[1]]$lib_size <- round(params[[1]]$lib_size*factor1)
            params[[1]]$simParaChangeList <- simParaChangeList
            params[[1]]$simParaChange <- simParaChange
            
            # Add normal noise to condition2
            print("Normal noise to lib size with mu2 and sd2 added to condition2")
            factor2 <- 2^rnorm(length(params[[2]]$lib_size), mean=simParaChangeList$mu2, sd=simParaChangeList$sd2)
            params[[2]]$lib_size <- round(params[[2]]$lib_size*factor2)
            params[[2]]$simParaChangeList <- simParaChangeList
            params[[2]]$simParaChange <- simParaChange
          }
    
  done=TRUE

  
  }
  if(!done){
    stop(paste0("simParaChange = ",simParaChange," not found.")) 
}
  return(params)  

}

